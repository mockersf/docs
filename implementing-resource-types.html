<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-60508041-1"></script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-60508041-1');
</script>

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=775" />
<title>Implementing a Resource Type - Concourse CI</title>
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/pipeline.css" />
<link rel="stylesheet" type="text/css" href="css/iosevka.css" />
<link rel="stylesheet" type="text/css" href="css/booklit.css" />
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700|Roboto+Slab:300,400,700" rel="stylesheet" />
<script src="js/search.js"></script>
  </head>
  <body>
    <div class="top-logo">
  <a href="/">Concourse</a>
</div>

<nav class="top-nav">
  
  <a href="docs.html" class="active">Docs</a>
  
  <a href="download.html">Download</a>
  
  <a href="project.html">Project</a>
  
  <a href="community.html">Community</a>
  
  <a href="learning.html">Learning</a>
  
</nav>

<div class="top-search">
  <div id="search"></div>
</div>

<script type="text/javascript">
  Elm.Main.init({
    node: document.getElementById('search')
  });
</script>

    <div class="page-nav">
      







  
  
  
  
  

  
  <div class="context">
    <nav>
      <div class="top">
        
        <span class="section-number">1</span>
        
        
  <a href="docs.html"  class="active">Docs</a>

      </div>

      <div class="children">
        <table>
        
          <tr>
            
              <td class="number-cell" align="right">1.1&nbsp;</td>
            
            <td class="title-cell">
  <a href="install.html" >Install</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.2&nbsp;</td>
            
            <td class="title-cell">
  <a href="auth.html" >Auth &amp; Teams</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.3&nbsp;</td>
            
            <td class="title-cell">
  <a href="fly.html" >The <code>fly</code> CLI</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.4&nbsp;</td>
            
            <td class="title-cell">
  <a href="pipelines.html" >Pipelines</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.5&nbsp;</td>
            
            <td class="title-cell">
  <a href="resources.html"  class="active">Resources</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.6&nbsp;</td>
            
            <td class="title-cell">
  <a href="jobs.html" >Jobs</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.7&nbsp;</td>
            
            <td class="title-cell">
  <a href="tasks.html" >Tasks</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.8&nbsp;</td>
            
            <td class="title-cell">
  <a href="builds.html" >Builds</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.9&nbsp;</td>
            
            <td class="title-cell">
  <a href="operation.html" >Operation</a>
</td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        
        <span class="section-number">1.5</span>
        
        
  <a href="resources.html"  class="active">Resources</a>

      </div>

      <div class="children">
        <table>
        
          <tr>
            
              <td class="number-cell" align="right">1.5.1&nbsp;</td>
            
            <td class="title-cell">
  <a href="managing-resources.html" >Managing Resources</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.5.2&nbsp;</td>
            
            <td class="title-cell">
  <a href="resource-types.html"  class="active">Resource Types</a>
</td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  

  

  
  <div class="context">
    <nav>
      <div class="top">
        
        <span class="section-number">1.5.2</span>
        
        
  <a href="resource-types.html"  class="active">Resource Types</a>

      </div>

      <div class="children">
        <table>
        
          <tr>
            
              <td class="number-cell" align="right">1.5.2.1&nbsp;</td>
            
            <td class="title-cell">
  <a href="included-resource-types.html" >Resource Types Provided With Concourse</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.5.2.2&nbsp;</td>
            
            <td class="title-cell">
  <a href="managing-resource-types.html" >Managing Resource Types</a>
</td>
          </tr>
        
          <tr>
            
              <td class="number-cell" align="right">1.5.2.3&nbsp;</td>
            
            <td class="title-cell">
  <a href="implementing-resource-types.html"  class="self">Implementing a Resource Type</a>
</td>
          </tr>
        
        </table>
      </div>
    </nav>
  </div>
  





<div class="context">
  <div class="page-toc">
    <nav>
      <div class="top">
        
        <span class="section-number">1.5.2.3</span>
        
        
  <a href="implementing-resource-types.html"  class="self">Implementing a Resource Type</a>

      </div>

      
<div class="children">
  <table>
    
      <tr>
        
          <td class="number-cell" align="left"></td>
        
        <td class="title-cell">
          <a href="implementing-resource-types.html#resource-check"><code>check</code>: Check for new versions.</a>

          
        </td>
      </tr>
    
      <tr>
        
          <td class="number-cell" align="left"></td>
        
        <td class="title-cell">
          <a href="implementing-resource-types.html#in"><code>in</code>: Fetch a given resource.</a>

          
        </td>
      </tr>
    
      <tr>
        
          <td class="number-cell" align="left"></td>
        
        <td class="title-cell">
          <a href="implementing-resource-types.html#out"><code>out</code>: Update a resource.</a>

          
        </td>
      </tr>
    
      <tr>
        
          <td class="number-cell" align="left"></td>
        
        <td class="title-cell">
          <a href="implementing-resource-types.html#resource-metadata">Metadata</a>

          
        </td>
      </tr>
    
      <tr>
        
          <td class="number-cell" align="left"></td>
        
        <td class="title-cell">
          <a href="implementing-resource-types.html#resource-certs">Certificate Propagation</a>

          
        </td>
      </tr>
    
  </table>
</div>

    </nav>
  </div>
</div>




    </div>

    <div class="page-aside"></div>

    <div class="page-content">
      <div class="section" id="section_implementing-resource-types">
  
  <h1 class="section-header"><a class="anchor" name="implementing-resource-types" href="#implementing-resource-types"></a><span class="section-number">1.5.2.3 </span>Implementing a Resource Type</h1>
  

  <p>A resource type is implemented by a container image with three scripts:</p><ul>

  <li><p><code>/opt/resource/check</code> for checking for new versions of the resource</p></li>

  <li><p><code>/opt/resource/in</code> for pulling a version of the resource down</p></li>

  <li><p><code>/opt/resource/out</code> for idempotently pushing a version up</p></li>

</ul><p>Distributing resource types as containers allows them to package their own dependencies. For example, the Git resource comes with <code>git</code> installed.</p><p>All resources must implement all three actions, though the actions can just be no-ops (which still must be correctly implemented as detailed below).</p><p>Resources can emit logs to the user by writing to <code>stderr</code>. ANSI escape codes (coloring, cursor movement, etc.) will be interpreted properly by the web UI, so you should make your output pretty.</p>

  
    
      <div class="section" id="section_resource-check">
  
  <h2 class="section-header"><a class="anchor" name="resource-check" href="#resource-check"></a><code>check</code>: Check for new versions.</h2>
  

  <p>A resource type&#39;s <code>check</code> script is invoked to detect new versions of the resource. It is given the configured source and current version on stdin, and must print the array of new versions, in chronological order, to stdout, including the requested version if it&#39;s still valid.</p><p>The request body will have the following fields:</p><ul>

  <li><p><code>source</code> is an arbitrary JSON object which specifies the location of the resource, including any credentials. This is passed verbatim from the <a href="resources.html">resource configuration</a>.</p><p>For <code>git</code> this would be the repo URI, which branch, and a private key if necessary.</p></li>

  <li><p><code>version</code> is a JSON object with <code>string</code> fields, used to uniquely identify an instance of the resource. For <code>git</code> this would be a commit SHA.</p><p>This will be omitted from the first request, in which case the resource should return the current version (<em>not</em> every version since the resource&#39;s inception).</p></li>

</ul><p>For example, here&#39;s what the input for a <code>git</code> resource may look like:</p><div class="highlight"><pre style="">{
  <span style="color:#9b59b6;font-weight:bold">&#34;source&#34;</span>: {
    <span style="color:#9b59b6;font-weight:bold">&#34;uri&#34;</span>: <span style="color:#e67e22">&#34;git://some-uri&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;branch&#34;</span>: <span style="color:#e67e22">&#34;develop&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;private_key&#34;</span>: <span style="color:#e67e22">&#34;...&#34;</span>
  },
  <span style="color:#9b59b6;font-weight:bold">&#34;version&#34;</span>: { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> }
}
</pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><div class="highlight"><pre style="">[ -d /tmp/repo ] || git clone git://some-uri /tmp/repo
<span style="color:#8f4b2d">cd</span> /tmp/repo
git pull &amp;&amp; git log 61cbef..HEAD
</pre></div><p>Note that it conditionally clones; the container for checking versions is reused between checks, so that it can efficiently pull rather than cloning every time.</p><p>And the output, assuming <code>d74e01</code> is the commit immediately after <code>61cbef</code>:</p><div class="highlight"><pre style="">[
  { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;61cbef&#34;</span> },
  { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;d74e01&#34;</span> },
  { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;7154fe&#34;</span> }
]
</pre></div><p>The list may be empty, if there are no versions available at the source. If the given version is already the latest, an array with that version as the sole entry should be listed.</p><p>If your resource is unable to determine which versions are newer then the given version (e.g. if it&#39;s a git commit that was <code>push -f</code>ed over), then the current version of your resource should be returned (i.e. the new <code>HEAD</code>).</p>

  
    
  
</div>
    
      <div class="section" id="section_in">
  
  <h2 class="section-header"><a class="anchor" name="in" href="#in"></a><code>in</code>: Fetch a given resource.</h2>
  

  <p>The <code>in</code> script is passed a destination directory as command line argument <code>$1</code>, and is given on stdin the configured source and a precise version of the resource to fetch.</p><p>The script must fetch the resource and place it in the given directory.</p><p>If the desired resource version is unavailable (for example, if it was deleted), the script must error.</p><p>The script must emit the fetched version, and may emit metadata as a list of key-value pairs. This data is intended for public consumption and will make it upstream, intended to be shown on the build&#39;s page.</p><p>The request will contain the following fields:</p><ul>

  <li><p><code>source</code> is the same value as passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>.</p></li>

  <li><p><code>version</code> is the same type of value passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>, and specifies the version to fetch.</p></li>

  <li><p><code>params</code> is an arbitrary JSON object passed along verbatim from <a href="get-step.html#get-step-params"><code><strong>params</strong></code></a> on a <a href="get-step.html"><code>get</code> step</a>.</p></li>

</ul><p>Example request, in this case for the <code>git</code> resource:</p><div class="highlight"><pre style="">{
  <span style="color:#9b59b6;font-weight:bold">&#34;source&#34;</span>: {
    <span style="color:#9b59b6;font-weight:bold">&#34;uri&#34;</span>: <span style="color:#e67e22">&#34;git://some-uri&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;branch&#34;</span>: <span style="color:#e67e22">&#34;develop&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;private_key&#34;</span>: <span style="color:#e67e22">&#34;...&#34;</span>
  },
  <span style="color:#9b59b6;font-weight:bold">&#34;version&#34;</span>: { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> }
}
</pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><div class="highlight"><pre style="">git clone --branch develop git://some-uri <span style="color:#3498db">$1</span>
<span style="color:#8f4b2d">cd</span> <span style="color:#3498db">$1</span>
git checkout 61cebf
</pre></div><p>And output:</p><div class="highlight"><pre style="">{
  <span style="color:#9b59b6;font-weight:bold">&#34;version&#34;</span>: { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> },
  <span style="color:#9b59b6;font-weight:bold">&#34;metadata&#34;</span>: [
    { <span style="color:#9b59b6;font-weight:bold">&#34;name&#34;</span>: <span style="color:#e67e22">&#34;commit&#34;</span>, <span style="color:#9b59b6;font-weight:bold">&#34;value&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> },
    { <span style="color:#9b59b6;font-weight:bold">&#34;name&#34;</span>: <span style="color:#e67e22">&#34;author&#34;</span>, <span style="color:#9b59b6;font-weight:bold">&#34;value&#34;</span>: <span style="color:#e67e22">&#34;Hulk Hogan&#34;</span> }
  ]
}
</pre></div>

  
    
  
</div>
    
      <div class="section" id="section_out">
  
  <h2 class="section-header"><a class="anchor" name="out" href="#out"></a><code>out</code>: Update a resource.</h2>
  

  <p>The <code>out</code> script is called with a path to the directory containing the build&#39;s full set of sources as the first argument, and is given on stdin the configured params and the resource&#39;s source configuration.</p><p>The script must emit the resulting version of the resource. For example, the <code>git</code> resource emits the sha of the commit that it just pushed.</p><p>Additionally, the script may emit metadata as a list of key-value pairs. This data is intended for public consumption and will make it upstream, intended to be shown on the build&#39;s page.</p><p>The request will contain the following fields:</p><ul>

  <li><p><code>source</code> is the same value as passed to <a href="implementing-resource-types.html#resource-check"><code>check</code></a>.</p></li>

  <li><p><code>params</code> is an arbitrary JSON object passed along verbatim from <a href="get-step.html#get-step-params"><code><strong>params</strong></code></a> on a <a href="put-step.html"><code>put</code> step</a>.</p></li>

</ul><p>Example request, in this case for the <code>git</code> resource:</p><div class="highlight"><pre style="">{
  <span style="color:#9b59b6;font-weight:bold">&#34;params&#34;</span>: {
    <span style="color:#9b59b6;font-weight:bold">&#34;branch&#34;</span>: <span style="color:#e67e22">&#34;develop&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;repo&#34;</span>: <span style="color:#e67e22">&#34;some-repo&#34;</span>
  },
  <span style="color:#9b59b6;font-weight:bold">&#34;source&#34;</span>: {
    <span style="color:#9b59b6;font-weight:bold">&#34;uri&#34;</span>: <span style="color:#e67e22">&#34;git@...&#34;</span>,
    <span style="color:#9b59b6;font-weight:bold">&#34;private_key&#34;</span>: <span style="color:#e67e22">&#34;...&#34;</span>
  }
}
</pre></div><p>Upon receiving this payload the <code>git</code> resource would probably do something like:</p><div class="highlight"><pre style=""><span style="color:#8f4b2d">cd</span> <span style="color:#3498db">$1</span>/some-repo
git push origin develop
</pre></div><p>And output:</p><div class="highlight"><pre style="">{
  <span style="color:#9b59b6;font-weight:bold">&#34;version&#34;</span>: { <span style="color:#9b59b6;font-weight:bold">&#34;ref&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> },
  <span style="color:#9b59b6;font-weight:bold">&#34;metadata&#34;</span>: [
    { <span style="color:#9b59b6;font-weight:bold">&#34;name&#34;</span>: <span style="color:#e67e22">&#34;commit&#34;</span>, <span style="color:#9b59b6;font-weight:bold">&#34;value&#34;</span>: <span style="color:#e67e22">&#34;61cebf&#34;</span> },
    { <span style="color:#9b59b6;font-weight:bold">&#34;name&#34;</span>: <span style="color:#e67e22">&#34;author&#34;</span>, <span style="color:#9b59b6;font-weight:bold">&#34;value&#34;</span>: <span style="color:#e67e22">&#34;Mick Foley&#34;</span> }
  ]
}
</pre></div>

  
    
  
</div>
    
      <div class="section" id="section_resource-metadata">
  
  <h2 class="section-header"><a class="anchor" name="resource-metadata" href="#resource-metadata"></a>Metadata</h2>
  

  <p>When used in a <a href="get-step.html"><code>get</code> step</a> or a <a href="put-step.html"><code>put</code> step</a>, metadata about the running build is made available via the following environment variables:</p><dl>
  
  <dt><code>$BUILD_ID</code></dt>
    <dd><p>The internal identifier for the build. Right now this is numeric but it may become a guid in the future. Treat it as an absolute reference to the build.</p></dd>
  
  <dt><code>$BUILD_NAME</code></dt>
    <dd><p>The build number within the build&#39;s job.</p></dd>
  
  <dt><code>$BUILD_JOB_NAME</code></dt>
    <dd><p>The name of the build&#39;s job.</p></dd>
  
  <dt><code>$BUILD_PIPELINE_NAME</code></dt>
    <dd><p>The pipeline that the build&#39;s job lives in.</p></dd>
  
  <dt><code>$BUILD_TEAM_NAME</code></dt>
    <dd><p>The team that the build belongs to.</p></dd>
  
  <dt><code>$ATC_EXTERNAL_URL</code></dt>
    <dd><p>The public URL for your ATC; useful for debugging.</p></dd>
  
</dl><p>If the build is a one-off, <code>$BUILD_NAME</code>, <code>$BUILD_JOB_NAME</code>, and <code>$BUILD_PIPELINE_NAME</code> will not be set.</p><p>None of these variables are available to <code>/check</code>.</p><p>These variables should be used solely for annotating things with metadata for traceability, i.e. for linking to the build in an alert or annotating an automated commit so its origin can be discovered.</p><p>They should <em>not</em> be used to emulate versioning (e.g. by using the increasing build number). They are not provided to <a href="task-step.html"><code>task</code> step</a>s to avoid this anti-pattern.</p>

  
    
  
</div>
    
      <div class="section" id="section_resource-certs">
  
  <h2 class="section-header"><a class="anchor" name="resource-certs" href="#resource-certs"></a>Certificate Propagation</h2>
  

  <p>Certificates can be automatically propagated into each resource container, if the worker is configured to do so. The BOSH release configures this automatically, while the <code>concourse</code> binary must be given a <code>--certs-dir</code> flag pointing to the path containing the CA certificate bundle.</p><p>The worker&#39;s certificate directory will then be always mounted at <code>/etc/ssl/certs</code>, read-only, in each resource container created on the worker. There&#39;s no single standard path for this so we picked one that would work out of the box in most cases.</p><p>This approach to certificate configuration is similar in mindset to the propagation of <code>http_proxy</code>/<code>https_proxy</code> - certs are kind of a baseline assumption when deploying software, so Concourse should do its best to respect it out-of-the-box, especially as they&#39;re often used in tandem with a man-in-the-middle corporate SSL proxy. (In this way it doesn&#39;t feel too much like the anti-pattern of hand-tuning workers.)</p>

  
    
  
</div>
    
  
</div>

      <nav class="prev-next">
      
        <div class="prev">
          prev:

          
          <span class="section-number">1.5.2.2</span>
          

          <a href="managing-resource-types.html">Managing Resource Types</a>
        </div>
      

      
        <div class="next">
          next:

          
          <span class="section-number">1.6</span>
          

          <a href="jobs.html">Jobs</a>
        </div>
      
      </nav>
    </div>

    <ul class="improve-docs">
      <li><img src="images/github.svg" /> <a href="https://github.com/concourse/docs">help improve this site</a></li>
      <li><img src="images/booklit.svg" /> powered by <a href="https://vito.github.io/booklit">Booklit</a></li>
    </ul>
  </body>
</html>